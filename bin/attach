#!/bin/sh

TMUXDIR=~/.tmux
# Later instances of -S will override the first, so it's safe to specify it
# here.
TMUX="tmux -S ${TMUXDIR}/sock"

mkdir -p "${TMUXDIR}" >/dev/null 2>&1

connect () {
    typeset SESSION=$1; shift
    if [ -r "${CONFIG}" ]; then
        typeset TMUX="${TMUX} -f ${CONFIG}"
    fi
    typeset TMUX="${TMUX} $*"

    # Call the callback if we create a new session and the callback is defined.
    typeset CONFIGS="${TMUXDIR}/${SESSION}.conf"
    typeset CONFIG
    if ${TMUX} new-session -ds "${SESSION}" >/dev/null 2>&1 && \
        [ -r "${TMUXDIR}/${SESSION}-new.conf" ]; then
        CONFIGS="${CONFIGS} ${TMUXDIR}/${SESSION}-new.conf"
    fi

    for CONFIG in ${CONFIGS}; do
        ${TMUX} source-file "${CONFIG}"
    done

    ${TMUX} attach-session -dt "${SESSION}"
}

remote () {
    typeset TARGETPAT=$1
    typeset TARGET=$2
    typeset SESSION=$3
    shift; shift; shift

    case $(hostname) in
        "${TARGETPAT}") connect "${SESSION}";;
        *) ssh -t "${TARGET}" '~/bin/'"${SESSION}";;
    esac
}

# If called as something other than 'attach', use ${PROG} as the session name.
SESSION="$(basename $0)"
case "${SESSION}" in
    master) connect master -S "${TMUXDIR}/master.sock";;
    comms|meta) remote "burko.*" "meta.lfod.us" "${SESSION}" $*;;
    attach) connect $*;;
    *) connect "${SESSION}" $*;;
esac
