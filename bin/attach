#!/bin/sh

TMUXDIR=~/.tmux
# Later instances of -S will override the first, so it's safe to specify it
# here.
TMUX="tmux -S ${TMUXDIR}/sock"

mkdir -p "${TMUXDIR}" >/dev/null 2>&1

connect () {
    typeset SESSION=$1; shift
    typeset TMUX="${TMUX} -f ${TMUXDIR}/${SESSION}.conf $*"

    # Call the callback if we create a new session and the callback is defined.
    if ${TMUX} new-session -ds "${SESSION}" >/dev/null 2>&1; then
        ${TMUX} source-file "${TMUXDIR}/${SESSION}-new.conf"
    fi
    ${TMUX} attach-session -dt "${SESSION}"
}

remote () {
    typeset TARGETPAT=$1
    typeset TARGET=$2
    typeset SESSION=$3
    shift; shift; shift

    case $(hostname) in
        "${TARGETPAT}") connect "${SESSION}";;
        *) ssh -t "${TARGET}" '~/bin/'"${SESSION}";;
    esac
}

# If called as something other than 'attach', use ${PROG} as the session name.
PROG="$(basename $0)"
case "${PROG}" in
    comms|meta) remote "burko.*" "meta.lfod.us" $0 $*;;
    attach) connect $*;;
    *) connect $0 $*;;
esac
