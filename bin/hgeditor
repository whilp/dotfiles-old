#!/bin/sh

_vi () {
    ${EDITOR} "$1"
    return $?
}

_vim () {
	msg="$1"

    sed -re '1,/^HG: --/d' < "$msg" > diff

    (echo; sed -nre "s/^HG: changed (.*)/\1/p" < "$msg" | xargs -r $hg diff --stat) >> diff
    (echo; sed -nre "s/^HG: changed (.*)/\1/p" < "$msg" | xargs -r $hg diff; echo) >> diff

    touch msg
    ${EDITOR} \
        "+startinsert" \
        "+e diff" \
        "+set buftype=help filetype=diff" \
        "+split msg" \
        "+resize 5" || return $?
    [ -s msg ] || return 1

    mv msg "$msg"
    return $?
}

msg=$(readlink -f "$1")
tmp=$(umask 077 && mktemp -td .hgeditor-XXXXXXXX)
trap "rm -rf $tmp" 0 1 2 3 6 15
hg="hg -R $PWD"

fn=_$(basename ${EDITOR})

(
cd "$tmp"
$fn "$msg"
return $?
)

exit $?
