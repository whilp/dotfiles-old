#!/bin/sh

_vi () {
    ${EDITOR} "$1"
    return $?
}

_vim () {
    ${EDITOR} \
        "+startinsert" \
        "+e diff" \
        "+set buftype=help filetype=diff" \
        "+split $1" \
        "+resize 5" || return $?
    [ -s $1 ] || return 1

    return $?
}

msg=$(readlink -f "$1")
tmp=$(umask 077 && mktemp -td .hgeditor-XXXXXXXX)
pwd="$PWD"
trap "rm -rf $tmp" 0 1 2 3 6 15

(
cd "$tmp"
touch msg
sed -re '1,/^HG: --/d' < "$msg" > msg
sed -nre "s/^HG: changed //p" < "$msg" > paths

(cd "$pwd"; xargs hg diff --stat) < paths > stat
(cd "$pwd"; xargs hg diff) < paths > diffs

(cat stat; echo; cat diffs) > diff

fn=_$(basename ${EDITOR})

$fn msg
mv msg "$msg"
)
exit $?
