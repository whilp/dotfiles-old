#!/bin/sh
HGTMP=""
cleanup_exit() {
    rm -rf "$HGTMP"
}

EDITOR=$(which nvi 2>/dev/null) || \
	EDITOR=$(which vi 2>/dev/null) || \
	EDITOR=$(which vim 2>/dev/null)

# Remove temporary files even if we get interrupted
trap "cleanup_exit" 0 # normal exit
trap "exit 255" 1 2 3 6 15 # HUP INT QUIT ABRT TERM

HGTMP="${TMPDIR-/tmp}/hgeditor.$RANDOM.$RANDOM.$RANDOM.$$"
(umask 077 && mkdir "$HGTMP") || {
    echo "Could not create temporary directory! Exiting." 1>&2
    exit 1
}

(
    grep '^HG: changed' "$1" | cut -b 13- | while read changed; do
        hg diff "$changed" >> "$HGTMP/diff"
    done
)

CKSUM=$(cksum "$HGTMP/msg")

sed -e '1,/^$/d' "$1" > "$HGTMP/msg"
echo "HG: diff follows" >> "$HGTMP/msg"
echo "" >> "$HGTMP/msg"
cat $HGTMP/diff >> $HGTMP/msg
$EDITOR "$HGTMP/msg" || exit $?

(echo "$CKSUM" | cksum -c >/dev/null 2>&1 && exit 13)

sed -e '/^HG: diff follows/,$d' "$HGTMP/msg" >| "$1"

exit $?
