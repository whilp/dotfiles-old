#!/bin/sh

tmp=$(umask 077 && mktemp -td .hgeditor-XXXXXXXX)
trap "rm -rf $tmp" 0 1 2 3 6 15

sed -re '1,/^HG: --/d' < "$1" > "$tmp/diff"
echo "" >> "$tmp/diff"
sed -nre "s/^HG: changed (.*)/\1/p" < "$1" | xargs hg diff >> "$tmp/diff"

(
cd "$tmp"
touch msg
vim \
    "+startinsert" \
    "+e diff" \
    "+set buftype=help filetype=diff" \
    "+split msg" \
    "+resize 5" || exit $?
)
[ -s "$tmp/msg" ] || exit 1

mv "$tmp/msg" "$1"
exit $?
