#!/usr/bin/env python
import cmd
import fnmatch
import os
import pwd
import time

from itertools import takewhile

from cli.log import LoggingApp

class Loop(cmd.Cmd):
    settable = ("dir", "datefmt", "msgfmt", "sep")

    def __init__(self, all=False, dir=".", datefmt="%Y-%m-%d", 
            msgfmt="%(message)s", sep="\t", tagchar="#", prompt="> ", user="", 
                *args, **kwargs):
        cmd.Cmd.__init__(self, *args, **kwargs)
        self.all = all
        self.dir = dir
        self.datefmt = datefmt
        self.msgfmt = msgfmt
        self.sep = sep
        self.tagchar = tagchar
        self._prompt = prompt
        self.user = user
        self.lasttag = ""
        self.matches = []

    @property
    def prompt(self):
        data = {
            "lasttag": getattr(self, "lasttag", ""),
            "lastdate": getattr(self, "lastdate", ""),
            "date": self.date,
            "user": self.user,
        }
        return self._prompt % data

    @property
    def date(self):
        return time.strftime(self.datefmt)

    @property
    def tags(self):
        return os.listdir(self.dir)

    def complete(self, text, state):
        if state == 0:
            self.matches = fnmatch.filter(self.tags, text.lstrip(self.tagchar) + "*")

        try:
            return self.matches[state]
        except IndexError:
            return None

    def default(self, line):
        fields = line.split()
        tags = []
        if not fields:
            return
        elif not fields[0].startswith(self.tagchar):
            if not self.lasttag:
                return
            last = self.tagchar + self.lasttag
            tags = [last]
            line = ' '.join((last, line))
        else:
            tags = [fields.pop(0)]
        tags.extend(takewhile(lambda x: x.startswith(self.tagchar), fields))
        tags = [t for t in tags if t]

        if not tags:
            return
        elif not self.all:
            tags = tags[:1]

        updatelast = True
        for tag in tags:
            tag = tag.lstrip(self.tagchar)
            if updatelast:
                self.lasttag = tag
                self.lastdate = self.date
                updatelast = False
            self.append(tag, line)

    def append(self, fname, line):
        data = {
            "message": line,
            "date": self.date,
            "sep": self.sep,
            "user": self.user,
        }
        message = self.msgfmt % data
        fname = os.path.join(self.dir, fname)
        try:
            os.makedirs(self.dir)
        except OSError, e:
            if e.errno != 17:
                raise
                
        if not fname.startswith(self.dir):
            return
        with open(fname, 'a') as f:
            f.write(message)

    def do_set(self, line):
        name, rest = line.split(None, 1)
        if name in self.settable:
            setattr(self, name, rest)

    # Exit and its synonyms.
    def do_exit(self, line):
        return True

    do_EOF = do_exit
    do_q = do_exit

class notes(LoggingApp):
    defaults = {
        "prompt": "%(lastdate)s %(lasttag)s > ",
        "dir": ".",
        "sep": "\t",
        "datefmt": "%Y-%m-%dT%H:%M:%S",
        "msgfmt": "%(sep)s".join(("%(date)s", "%(user)s", "%(message)s\n")),
        "user": pwd.getpwuid(os.geteuid()).pw_name,
    }
    
    def main(self):
        loop = Loop(
            stdin=self.stdin,
            stdout=self.stdout,
            all=self.params.all,
            dir=self.params.dir[0],
            datefmt=self.params.datefmt,
            msgfmt=self.params.msgfmt,
            prompt=self.params.prompt,
            sep=self.params.sep,
            user=self.params.user)
        loop.log = self.log
        try:
            loop.cmdloop()
        except KeyboardInterrupt:
            pass
        self.stdout.write('\n')

    def setup(self):
        LoggingApp.setup(self)
        self.add_param("-a", "--all", default=False, action="store_true",
            help="log note to separate files for each tag "
                "(default: only the first tag)")
        self.add_param("-d", "--datefmt", default=self.defaults["datefmt"],
            help="strftime(3) date format (default: %r)" % 
                self.defaults["datefmt"].replace("%", "%%"))
        self.add_param("-m", "--msgfmt", default=self.defaults["msgfmt"],
            help="logging.Formatter message format (default: %r)" % 
                self.defaults["msgfmt"].replace("%", "%%"))
        self.add_param("-p", "--prompt", default=self.defaults["prompt"],
            help="interpreter prompt (default: %r)" % 
                self.defaults["prompt"].replace("%", "%%"))
        self.add_param("-S", "--sep", default=self.defaults["sep"],
            help="record separator (default: %(sep)r)" % self.defaults)
        self.add_param("-u", "--user", default=self.defaults["user"],
            help="user name (default: %(user)r)" % self.defaults)
        self.add_param("dir", nargs=1, default=self.defaults["dir"],
            help="notes working directory (default: %(dir)s)" % self.defaults)

if __name__ == "__main__":
    notes().run()
