#!/bin/sh -e

CHROOTHOST=localhost
CHROOTUSER=$(whoami)
unset SETROOT

usage () {
    echo "mychroot [-H CHROOTHOST] [-s SETROOT] [-u CHROOTUSER] CHROOTDIR"
}

say () {
    echo "===> $*"
}

error () {
    echo "=!=> $*"
}

makeabs () {
    OPWD="${PWD}"
    cd "$1"
    echo $PWD
    cd "${OPWD}"
}

enter_chroot () {
    ssh "${CHROOTUSER}@${CHROOTHOST}"
}

build_chroot () {
    mkdir -p "${CHROOTDIR}"
    for FILESET in "${SETROOT}"/*.tgz; do
        say "Extracting $(basename ${FILESET})"
        tar -xzp -C "${CHROOTDIR}" -f "${FILESET}"
    done
    
    say "Installing kernels and ramdisk"
    cp "${SETROOT}"/bsd* "${CHROOTDIR}/"
    
    say "Running MAKEDEV"
    cd "${CHROOTDIR}/dev"
    ./MAKEDEV all >/dev/null
    
    say "Installing passwd and group files"
    cp /etc/master.passwd /etc/group "${CHROOTDIR}"/etc/.
    chroot "${CHROOTDIR}" pwd_mkdb -p /etc/master.passwd

    say "Updating /etc/{localtime,resolv.conf}"
    ln -sf "$(readlink /etc/localtime)" "${CHROOTDIR}/etc/localtime"
    cp "/etc/resolv.conf" "${CHROOTDIR}/etc/resolv.conf"
    
    say "Updating dev.db and ld.so.hints"
    chroot "${CHROOTDIR}" dev_mkdb
    chroot "${CHROOTDIR}" ldconfig /usr/lib /usr/local/lib /usr/X11R6/lib
}

while getopts H:hs:u: ARG; do
    case "${ARG}" in
        H) CHROOTHOST="${OPTARG}";;
        s) SETROOT=$(makeabs "${OPTARG}");;
        *) usage; exit 1;;
    esac
done

shift $(($OPTIND - 1))
CHROOTDIR=$(makeabs "$1")

if [ -z "${SETROOT}" ]; then
    enter_chroot
else
    if [ "`id -u`" -ne 0 ]; then
        error "need root privileges to run this script"
        usage
        exit 1
    fi
    build_chroot
fi
