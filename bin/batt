#!/bin/sh

sysctln () {
    sysctl -n $* | sed -e 's/ .*$//'
}

calcl () {
    cat <<EOF | bc -l
    scale=2
    $*
EOF
}

calc () {
    cat <<EOF | bc
    $*
EOF
}

set -- $(sysctln hw.sensors.acpibat0)
VOLTAGE=$1
CURRENT=$2
FULL=$3
WARN=$4
LOW=$5
REMAINING=$6
RAW=$7
RATE=$8

if [ "${RATE}" -eq 0 ]; then
    printf "full\n"
    exit 0
fi

# Calculate the minutes with scale=2 and then drop the digits.
MINUTES=$(calcl "60 * ((1000 * ${REMAINING})/${RATE})")
MINUTES=${MINUTES%.*}

if [ "${MINUTES}" -gt 60 ]; then
    HOURS=$(calc "${MINUTES} / 60")
    MINUTES=$(calc "${MINUTES} % 60")
    if [ "${MINUTES}" -eq 0 ]; then
        printf "%dh" "${HOURS}"
    else
        printf "%dh %dm" "${HOURS}" "${MINUTES}"
    fi
else
    printf "%dm" "${MINUTES}"
fi


PERCENT=$(calcl "100 * ${REMAINING}/${FULL}")

printf " (%.02f%%)" "${PERCENT}"

if [ $(calcl "${REMAINING} < ${LOW}") -eq 1 ]; then
    printf "  LOW"
fi

printf "\n"
