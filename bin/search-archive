#!/usr/bin/env python

from gzip import GzipFile
from mailbox import PortableUnixMailbox as Mailbox

doc = lambda d, f: setattr(f, "__doc__", d) or f
doc("""Apply docstring 'd' to function 'f'.""", doc)

match_msg = doc(
    """Return True if pattern 'p' matches any line in message 'm'.""",
    lambda p, m: [l for l in \
            m.fp.read().splitlines() if p.match(l)] and True or False
)

mbox = doc(
    """Return an instance of Mailbox at fileobj 'f'.""",
    lambda f: Mailbox(GzipFile(fileobj=f)),
)

mboxgrep = doc(
    """Return a list of messages in fileobj 'm' matching pattern 'p'.""",
    lambda p, m: [msg for msg in mbox(m) if match_msg(p, msg)]
)


if __name__ == "__main__":
    import re
    import sys

    from itertools import chain
    from mailbox import Maildir

    pattern, files = sys.argv[1], sys.argv[2:]
    results_dir = Maildir("results")
    
    pattern = re.compile(pattern)
    sources = (open(f, 'r') for f in files)
    results = chain(mboxgrep(pattern, s) for s in sources)
    [results_dir.add(r) for r in results]
