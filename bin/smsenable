#!/bin/sh

IDLETHRESHOLD=600   # ten minutes
SMSCACHE=~/.maildir/cache/sms
KEY=send-sms

is_idle () {
    TTYS=$(find /dev -type c -name "tty*" -user "${USER}")
    TTY=$(ls -t ${TTYS} | head -1)
    MTIME=$(stat -t '%s' -f '%m' "${TTY}")
    NOW=$(date '+%s')

    [[ "$(($NOW - $MTIME))" -gt "${IDLETHRESHOLD}" ]]
    return $?
}

replace () {
    PATTERN=$1
    FILE=$2
    cp "${FILE}" "${FILE}.orig"
    sed -e "${PATTERN}" "${FILE}.orig" >| "${FILE}"
}

enable () {
    replace 's/\$nosms/\$sms/' ~/.forward
}

disable () {
    replace 's/\$sms/\$nosms/' ~/.forward
}

case $1 in
    enable) enable;;
    disable) disable;;
    *) is_idle && enable || disable;;
esac
