#!/bin/sh

IDLETHRESHOLD=600   # ten minutes
SMSCACHE=~/.maildir/cache/sms
KEY=send-sms
LOG=~/.smsenable.log

exec >>"${LOG}" 2>&1

find_tty () {
    USER=$1
    TTYS=$(find /dev -maxdepth 1 -type c -name "tty*" -user "${USER}")
    TTY=$(ls -ut ${TTYS} | head -1)

    echo "${TTY}"
}

find_tty () {
    USER=$1
    TTY=$(w -hi "${USER}" | awk "{if (/${USER}/ && NR == 2) print \$2}")

    echo "/dev/tty${TTY}"
}

is_idle () {
    USER=$1
    IDLE=0

    TTY=$(find_tty "${USER}")
    [ -n "${TTY}" -a -e "${TTY}" ] || return 0
    TIME=$(stat -t '%s' -f '%a' "${TTY}")
    NOW=$(date '+%s')
    [[ "$(($NOW - $TIME))" -gt "${IDLETHRESHOLD}" ]]
    return $?
}

replace () {
    PATTERN=$1
    FILE=$2
    cp "${FILE}" "${FILE}.orig"
    sed -e "${PATTERN}" "${FILE}.orig" >| "${FILE}"
}

enable () {
    echo "===> $(date) enabling"
    replace 's/\$nosms/\$sms/' ~/.forward
}

disable () {
    echo "===> $(date) disabling"
    replace 's/\$sms/\$nosms/' ~/.forward
}

case $1 in
    enable) enable;;
    disable) disable;;
    *) is_idle "${USER}" && enable || disable;;
esac
