#!/usr/bin/env python

import os
import sys
import time

from itertools import dropwhile

fname = sys.argv[1]
f = None

while True:
    if f is None or f.name != fname:
        f = open(fname)
        f.seek(0, 2)

    line = f.readline()
    if not line:
        time.sleep(1)
    if "Completed" not in line:
        continue

    fields = "datetime _ _ _ pool pnfsid path".split()
    fields = dict(zip(fields, [x.strip("(',)") for x in line.split()]))
    path = os.path.abspath(fields["path"])
    if "store" in path:
        path = dropwhile(lambda x: x != "store", fields["path"].split('/'))
        path = '/'.join(list(path)[1:-1])
    elif path.startswith("/pnfs/hep.wisc.edu"):
        path = path[19:]

    extra = 57 - len(path)
    if extra < 0:
        path = path[:extra] + "..."
    fields["path"] = path
    out = "%(datetime)19s %(pool)9s %(path)-60s" % fields
    print out
