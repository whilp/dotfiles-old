include ".fdm/patterns"

# Dump duplicates.
$dupcache = "${cache}/msgid"
match "^Message-Id: (.*)" in headers {
    match in-cache "${dupcache}" key "%1" action drop
    match all action to-cache "${dupcache}" key "%1" continue
}

# Shortcut local mail.
match "From.*root@[^ ]*\\.lfod\\.us" action "lfod"

# Drop stuff I don't care about.
match "^From:.*(${useless})" in headers action "drop"

# RATM (Feed Fetcher).
match "^X-Feed-Parser.*RATM" in headers {
    match "^X-Feed: Chicagoist" in headers {
        match "Subject: \\[Sponsored\\]" in headers action drop
    }
    match "^X-Feed: Twitter" in headers {
        match "follow.*friday" in headers action drop
        match "Atlantic Politics:" in headers action drop
        match all action "twitter"
    }
    match "^X-Feed: The Daily Dish | By Andrew Sullivan" in headers {
        match "(The View From Your Window|Cool Ad Watch|Faces? of the day)" action drop
    }
    match "^X-Feed: POLITICO" in headers {
        match case "VIDEO:" in headers action drop
    }
    match "^X-Feed: NYT" in headers {
        match $ignore_nyt_domains or $ignore_nyt_articles in headers action drop
        match "To the Editor:." in body action drop
    }
    match "friday.*squid.*blog" in headers action drop
    match all action "news"
}

# SPAM trap.
match all action "spambayes" continue
match "^X-Spambayes-Classification: spam" in headers action "spam"

# LUGs.
match "^List-Id:.*hacker-within\\.googlegroups\\.com" in headers action maildir "${groups}/hackerwithin"
match "^List-Id:.*video-game-church\\.googlegroups\\.com" in headers action maildir "${groups}/vgc"
match "^List-Id:.*madlug\\.madisonlinux\\.org" in headers action maildir "${groups}/madlug"
match "^List-Id:.*mlug-list\\.mail\\.milwaukeelug\\.org" in headers action maildir "${groups}/mkelug"
match "^List-Id:.*<lopsa-us-wi-mad\\.lists\\.lopsa\\.org>" in headers action maildir "${groups}/lopsa"
match "^X-Mailinglist: talk@metabug\\.org$" in headers action maildir "${groups}/metabug"
match "^List-Id: Mailing list for MadSec <madsec-foofus\\.net>" in headers action maildir "${groups}/madsec"
match "^List-ID:.*<madlug-book-club\\.googlegroups\\.com>" in headers action maildir "${groups}/madbook"
match "^List-Id:.*<chicago\\.python\\.org>" in headers action maildir "${groups}/chipy"
match "^List-ID:.*<devops-toolchain\\.googlegroups\\.com>" in headers action maildir "${groups}/devops.toolchain"
match "^List-ID: <chicagolinux-discuss\\.googlegroups\\.com>" in headers action maildir "${groups}/chilug"

# FOSS.
match "^List-Id:.*mercurial\\.selenic\\.com" in headers action maildir "${foss}/hg"
match "List-Id:.*<mercurial-devel\\.selenic\\.com>" in headers action maildir "${foss}/hg.dev"
match "^List-Id:.*ipython-(user|dev)\\.(ipython\\.)?scipy\\.org" in headers action maildir "${foss}/ipython"
match "^List-Id:.*Radmind Users <radmind-users\\.lists\\.sourceforge\\.net>" in headers action maildir "${foss}/radmind"
match "^List-Id:.*roundup-users\\.lists\\.sourceforge\\.net" in headers action maildir "${foss}/roundup"
match "^List-Id:.*<redis-db\\.googlegroups\\.com>" in headers action maildir "${foss}/redis"
match "^List-Id:.*fab-user\\.nongnu\\.org" in headers action maildir "${foss}/fabric"
match "^X-Redmine-Site:.*Fabric Code/Issue Tracking" in headers action maildir "${foss}/fabric"

# OpenBSD.
match "^Sender:[ \t]*owner-([a-z-]*)@openbsd\\.org" in headers {
    match string "%1" to "gnats" action maildir "${obsd}/bugs"
    match string "%1" to "(ports|source)-changes" action maildir "${obsd}/cvs"
    match all action maildir "${obsd}/%1"
}

# Techpartners.
match "^(To|Cc):.*techpartners@lists\\.(services\\.)?wisc\\.edu" in headers action maildir "${uw}/techpartners"
match "^(To|Cc):.*researchdata@lists\\.wisc\\.edu" in headers action maildir "${uw}/researchdata"

# Security.
match "^List-Id:.*bugtraq\\.list-id\\.securityfocus\\.com" in headers action maildir "${sec}/bugtraq"
match "^List-Id:.*dailydave\\.lists\\.immunitysec\\.com" in headers action maildir "${sec}/dailydave"
match "^From:.*sec-adv@secunia\\.com" in headers {
    match "^Subject: \\[SA[0-9]+\\] (apple|ubuntu|fedora|debian)" in headers action drop
    match all action maildir "${sec}/secunia"
}

$urgent = "^((To|CC|Bcc).*(will|wcmaier)\\+(sms|text)@|Subject:.*(URGENT|IMPORTANT))"

# Family.
match "List-Id: <weekend-reading\\.m\\.aier\\.us>" in headers action maildir "${groups}/wr"
match "List-Id:.*kids\\.m\\.aier\\.us" or "^From:.*(${family})" in headers {
    match all action "family" continue
    match $urgent in headers action "sms"
    match all action drop
}

# Friends.
match "From:.*(${friends})" in headers {
        match all action "friend" continue
        match $urgent in headers action "sms"
        match all action drop
}

# GLOW/CHTC/CS.
match "^List-Id:.*glow-tech\\.cs\\.wisc\\.edu" in headers {
    match "^Subject: .* GLOW Absent Report$" in headers action maildir "${hep}/monitor"
	match "^Subject: .* Daily GLOW usage" in headers action maildir "${hep}/monitor"
    match all action maildir "${hep}/glow"
}
match "List-Id: <chtc-users\\.cs\\.wisc\\.edu>" in headers {
    match "Subject: \\[Chtc-users\\] Daily CHTC usage" in headers action maildir "${hep}/monitor"
	match all action maildir "${hep}/chtc"
}
match "List-Id: <cs-announce\\.cs\\.wisc\\.edu>" in headers action "hep"

# Hadoop.
match "^From:.*jenkins@builds.apache.org" in headers action "drop"
match "^List-Id: <(.*)\\.hadoop\\.apache\\.org>" in headers {
    match all action maildir "${hadoop}/%1"
}
match "^List-ID: <(.*)\\.cloudera\\.org>" in headers {
    match all action maildir "${hadoop}/%1"
}

# CMS.
match "List-Owner: <mailto:USCMS-ALL-request@LISTSERV\\.FNAL\\.GOV>" in headers action maildir "${cms}/uscms-all"
match "List-Owner: <mailto:CMS-T2-request@LISTSERV\\.FNAL\\.GOV>" in headers action maildir "${cms}/uscms-t2"
match "^From: RSV Reporting System" in headers action maildir "${hep}/monitor"
match "^List-Owner:.*XROOTD-DEMONSTRATOR.*@LISTSERV\\.FNAL\\.GOV" in headers action maildir "${osg}/xrootd-demo"
match "^(To|Cc):.*project-indico-administrators@cern\\.ch" in headers action maildir "${cms}/indico"
match "From: Gratia Operation" in headers and "Subject: OSG site metrics" in headers action maildir "${hep}/monitor"
match "From: RSV Reporting System" in headers action maildir "${hep}/monitor"
match "^(To|Cc):.*@(lists[0-9]+)?\\.?slac\\.stanford\\.edu" in headers {
    match "^(To|Cc).*xrootd-l@" in headers action maildir "${cms}/xrootd"
}
match "^X-Hn-Forum:" in headers {
    match "X-Hn-Forum:.*/HyperNews/CMS/get/([a-zA-Z0-9-]+)\\.html" in headers action maildir "${cms}/hn.%1"
}

# OSG
match "^From:.*osg@tick\\.globalnoc\\.iu\\.edu" in headers action maildir "${osg}/goc"
match "^(To|Cc):.*osg-([a-z-]*)@(fnal.gov|opensciencegrid.org)" in headers {
    match all action maildir "${osg}/%2"
}

# HEP.
match "^To:.*postmaster@hep.wisc.edu" in headers action "drop"
match "^X-Savane-Server: savannah.cern.ch:443" in headers {
    match all action maildir "${hep}/savannah" continue
    match all action "sms"
}
match "^List-Owner:.*JOBS-request@LISTSERV\\.FNAL\\.GOV" in headers {
    match ": cs, ..." in body action "hep"
    match all action "drop"
}
match "^From:.*cms-phedex-admins@cern\\.ch" in headers action maildir "${hep}/phedex"
match "List-Id: .* <cms-physics\\.physics\\.wisc\\.edu>" in headers action maildir "${hep}/cms.physics"
match "From:.*postmaster@hep\\.wisc\\.edu" in headers and "Subject: Quarantined spam" in headers action drop
match "^Subject: glow.*cp_afs_ca problems" in headers action drop
match "^Subject:.*fetch-crl" in headers and "^From: root" in headers action drop
match "From: nagios <nagios@red-mon\\.unl\\.edu>" in headers action maildir "${hep}/nagios"
match "^(From|To|Cc):.*@[^ ]*\\.?hep\\.wisc\\.edu" in headers {
    match "(From|To|Cc):.*(help|req)@(nod|ginseng)?\\.?hep\\.wisc\\.edu" in headers {
        match all action maildir "${hep}/req" continue
        match "X-Roundup-issue-status: unread" action "sms"
        match all action drop
    }
    match "^From:.*nagios@" and "^Subject: (UP|DOWN|RECOVERY|PROBLEM):" in headers { 
        match all action maildir "${hep}/nagios" continue
        match "^Subject: (UP|DOWN): [gs][0-9]+n[0-9]+$" action drop
        match "^Subject: (PROBLEM|RECOVERY): .*(dCache|Condor|Slash)" action drop
        match "^Subject: .*(NetWorker|DESY)" action drop
        match all action "sms"
    }
    match "^Subject: (${hep_reports})" in headers action maildir "${hep}/monitor"
    match "^Subject: AIDE report" or "^Subject: .* file integrity .*report" in headers action drop
    # HEP root mail.
    match "^(From|To|Cc):.*(root|operator|cron)@[^ ]*\\.?hep" in headers {
        match "^Subject: IDS CRITICAL: intrusion detected" in headers action drop
        match "^From: .*coffee\\.hep\\.wisc\\.edu" in headers action drop
        match all action maildir "${hep}/root"
    }
    match all action "hep"
}
match "^(To|Cc):.*(William\\.Maier|wcmaier)@cern\\.ch" in headers action "hep"
match "^From:.*@cern\\.ch" in headers action "hep"

# Physics.
match "^(From|To|Cc):.*@[^ ]*\\.?physics\\.wisc\\.edu" in headers {
    match "^(To|Cc):.*(it-staff)@" in headers action "hep"
    match "^(To|Cc):.*(root|operator|cron)@" in headers action maildir "${hep}/root"
    match all action maildir "${hep}/department"
}

# Default filter.
match all action "default"
