# vim: set nospell:

# Settings.
set lock-types flock
#set maximum-size 10M
set allow-multiple

# Macros.
$path   = "%h/.maildir"
$attic  = "${path}/attic"
$cms    = "${path}/cms"
$foss   = "${path}/foss"
$groups = "${path}/groups"
$hep    = "${path}/hep"
$obsd   = "${path}/obsd"
$osg    = "${path}/osg"
$sec    = "${path}/sec"
$uw     = "${path}/uw"
$cache  = "${path}/cache"
$smsrewrite = "%h/bin/smsrewrite"

# Actions.
action "drop" drop
action "keep" keep
action "default" { action "inbox" }

action "deliver-sms"    maildir "${path}/sms"
action "family"         maildir "${path}/family"
action "friend"         maildir "${path}/friend"
action "inbox"          maildir "${path}/inbox"
action "lfod"           maildir "${path}/lfod"
action "news"           maildir "${path}/news"
action "sent"           maildir "${path}/sent"
action "spam"           maildir "${path}/spam"
action "twitter"        maildir "${path}/twitter"
action "hep"            maildir "${hep}/inbox"

action "enable-sms" { add-to-cache "${cache}/sms" key "send-sms" action "deliver-sms" }
action "disable-sms" { remove-from-cache "${cache}/sms" key "send-sms" action "deliver-sms" }
action "rewrite-sms" { rewrite "${smsrewrite}" }
action "drop-body" rewrite "sed -e '/^$/,$d'"
action "send-sms" smtp server "localhost" to "6084386162@txt.att.net"
action "sms" { action "deliver-sms" action "rewrite-sms" action "send-sms" }

action "spambayes"  rewrite "/home/will/bin/spambayes"

# Caches.
cache "${cache}/msgid" expire 1 week
cache "${cache}/subject" expire 1 hour
cache "${cache}/sms" expire 1 hour
cache "${cache}/headlines" expire 1 day

# The stdin account is disabled: it will be ignored unless
# explicitly requested using the -a switch on the command line.
account "stdin" disabled stdin

# Accounts.
account "local" disabled stdin

# Filter rules.

# Archives.
ifdef ${archive}
account "archive" maildir "${path}/${archive}"
match account "archive" and age invalid or age > 30 days action mbox "${attic}/${archive}" compress
match account "archive" action keep
endif

ifdef ${prune}
account "prune" maildir "${path}/${prune}"
#match account "prune" and age invalid or age > 1 month action drop
match account "prune" action keep
endif

ifdef ${search}
ifdef ${archive}
account "search" mbox "${archive}" keep
match account "search" and "${search}" action maildir "${path}/results"
match account "search" action keep
endif
endif

ifndef ${archive}
# Dump duplicates.
$dupcache = "${cache}/msgid"
match "^Message-Id: (.*)" in headers {
    match in-cache "${dupcache}" key "%1" action drop
	match all action to-cache "${dupcache}" key "%1" continue
}

# Shortcut local mail.
match account "local" and
    "From.*root@[^ ]*\\.lfod\\.us" action "lfod"

# Enable/disable SMS and handle SMS alias. Mail to will+text will
# always be forwarded via SMS. If SMS is enabled, other messages
# that match certain of the following rules will also be forwarded
# to SMS (in addition to being delivered normally).
match "^(To|CC|Bcc).*(will|wcmaier)\\+(sms|text)@" in headers action "sms"

# Drop stuff I don't care about.
match 
    "^From:.*@enews\\.buy\\.com" or
    "^From:.*TigerDirect@promo\\.tigeronline\\.com" or 
    "^From:.*AtBattcom@" or
    "^From:.*socialinnovation@conversationsnetwork\\.org" or
    "^From:.*phil@windley\\.org" or
    "^From:.*@newsletters\\.sdmediagroup\\.com" or
    "^From:.*adidas@adidasusnews\\.com" or
    "^From:.*newsletter@reply\\.ticketmaster\\.com" or
    "^From:.*UnityDeals@unityelectronics\\.com" or
    "^From:.*dotnews@mkt\\.dotster\\.com" or
    "^From:.*cpservice@compuplus\\.com" or
    "^From:.*technews@ACM\\.ORG" or
    "^From:.*rlopahle@gmail\\.com" or
    "^From:.*hob@email\\.livenationent\\.com" or
    "^From:.*technews@HQ\\.ACM\\.ORG" or
    "^In-Reply-To: ef0668780905141130r62e36390sd91d8ecca2979140@mail.gmail.com"
    in headers action "drop"

# RATM (Feed Fetcher).
match "^X-Feed-Parser.*RATM" in headers {
    match "^X-Feed: Chicagoist" in headers {
        match "Subject: \\[Sponsored\\]" in headers action drop
    }
    match "^X-Feed: Twitter" in headers {
        match "follow.*friday" in headers action drop
        match "Atlantic Politics:" in headers action drop
        match all action "twitter"
    }
    match "^X-Feed: The Daily Dish | By Andrew Sullivan" in headers {
        match "(The View From Your Window|Cool Ad Watch|Faces? of the day)" action drop
    }
    match "^X-Feed: POLITICO" in headers {
        match case "VIDEO:" in headers action drop
    }
    match "^X-Feed: NYT" in headers {
        match 
        "X-Item-Link: http://(travel).nytimes.com/" or
        "X-Item-Link: http://(realestateqa|runway|formulaone).blogs.nytimes.com/" or
        "X-Item-Link: http://(greeninc|thechoice|cityroom|themoment|well).blogs.nytimes.com/" or
        "X-Item-Link: http://(fort-greene|maplewood|dotearth|slapshot|wordplay).blogs.nytimes.com/" or 
        "X-Item-Link: http://(happydays|timestraveler|carpetbagger|bats|therail|tvdecoder).blogs.nytimes.com/" or
        "X-Item-Link: http://(globespotters|wheels|thequad|fifthdown|travelqa|laughlines).blogs.nytimes.com/" or
        "X-Item-Link: http://www.nytimes.com/[0-9/]+/(realestate|fashion|crosswords|garden|greathomesanddestinations)/" or
        "X-Item-Link: http://www.nytimes.com/[0-9/]+/sports/(baseball|football|golf|hockey|autoracing|rugby|cricket)/" or
        "X-Item-Link: http://www.nytimes.com/[0-9/]+/arts/dance/" or
        "X-Item-Link: http://www.nytimes.com/[0-9/]+/nyregion/" or
        "X-Item-Link: http://www.nytimes.com/[0-9/]+/sports/opinion/l"
        in headers action drop
        match "To the Editor:." in body action drop
    }
    match "friday.*squid.*blog" in headers action drop
    match all action "news"
}

# SPAM trap.
match all action "spambayes" continue
match "^X-Spambayes-Classification: spam" in headers action "spam"

# LUGs.
match "^List-Id:.*madlug\\.madisonlinux\\.org" in headers action maildir "${groups}/madlug"
match "^List-Id:.*mlug-list\\.mail\\.milwaukeelug\\.org" in headers action maildir "${groups}/mkelug"
match "^List-Id:.*lopsa-us-wi-mad\\.lopsa\\.org" in headers action maildir "${groups}/lopsa"
match "^X-Mailinglist: talk@metabug\\.org$" in headers action maildir "${groups}/metabug"
match "^List-Id: Mailing list for MadSec <madsec-foofus\\.net>" in headers action maildir "${groups}/madsec"

# FOSS.
match "^List-Id:.*mercurial\\.selenic\\.com" in headers action maildir "${foss}/hg"
match "List-Id:.*<mercurial-devel\\.selenic\\.com>" in headers action maildir "${foss}/hg.dev"
match "^List-Id:.*ipython-(user|dev)\\.(ipython\\.)?scipy\\.org" in headers action maildir "${foss}/ipython"
match "^List-Id:.*Radmind Users <radmind-users\\.lists\\.sourceforge\\.net>" in headers action maildir "${foss}/radmind"
match "^List-Id:.*roundup-users\\.lists\\.sourceforge\\.net" in headers action maildir "${foss}/roundup"

# OpenBSD.
match "^Sender:[ \t]*owner-([a-z-]*)@openbsd\\.org" in headers {
    match string "%1" to "gnats" action maildir "${obsd}/bugs"
    match string "%1" to "(ports|source)-changes" action maildir "${obsd}/cvs"
    match all action maildir "${obsd}/%1"
}

# Techpartners.
match "^(To|Cc):.*techpartners@lists\\.(services\\.)?wisc\\.edu" in headers action maildir "${uw}/techpartners"

# Security.
match "^List-Id:.*bugtraq\\.list-id\\.securityfocus\\.com" in headers action maildir "${sec}/bugtraq"
match "^List-Id:.*dailydave\\.lists\\.immunitysec\\.com" in headers action maildir "${sec}/dailydave"
match "^From:.*sec-adv@secunia\\.com" in headers {
    match "^Subject: \\[SA[0-9]+\\] (apple|ubuntu|fedora|debian)" in headers action drop
    match all action maildir "${sec}/secunia"
}

# Family.
match "List-Id:.*kids\\.m\\.aier\\.us" in headers action "family"
match 
    "^From:.*ajdj143@gmail\\.com" or 
    "^From:.*adeepergrey@(excite|gmail)\\.com" or
    "^From:.*beachbumbutterfly@yahoo\\.com" or
    "^From:.*bridgetcash@gmail\\.com" or
    "^From:.*cbroad@comcast\.net" or
    "^From:.*ginaryan@aol\\.com" or
    "^From:.*gina\\.ryan@mac\\.com" or
    "^From:.*marquisa@charter\\.net" or
    "^From:.*jacobsonlaura@(hotmail|gmail)\\.com" or
    "^From:.*ljacobson@(deltanoid\\.com|biochem\\.wisc\\.edu)" or
    "^From:.*mickey\\.maier@tmo\\.blackberry\\.net" or
    "^From:.*jmaier7@wi\\.rr\\.com" or
    "^From:.*mmaier@alpha-investment\\.com" or
    "^From:.*linuxmaier@(fastmail\\.fm|yahoo\\.com)" or
    "^From:.*rosie\\.maier@gmail\\.com" or
    "^From:.*maier1@wisc\\.edu" or
    "^From:.*maier@wi\\.rr\\.com" or
    "^From:.*maierfest@aol\\.com" or
    "^From:.*mmaier@stewart-peterson\\.com" or
    "^From:.*pbroad@iopener\\.net" or
    "^From:.*madsimian@gmail\\.com" or
    "^From:.*sharonmaier@gmail\\.com" or
    "^From:.*theend1313@aol\\.com" or
    "^From:.*broadwm@aol\\.com" or
    "^From:.*tanyamohn@aol\\.com" or
    "^From:.*wegmann@sbcglobal\\.net"
    in headers action "family"

# Friends.
match 
    "^From:.*aquaranger@hotmail\\.com" or
    "^From:.*butterflyschmid@yahoo\\.com" or
    "^From.*goonmcglynn@yahoo\\.com" or
    "^From:.*greg\\.keltner@gmail\\.com" or
    "^From:.*hastings\\.cameron@gmail\\.com" or
    "^From:.*hitbyguitarz@yahoo\\.com" or
    "^From:.*kafka@riseup\\.net" or
    "^From:.*katwodtke@wi\\.rr\\.com" or
    "^From:.*kavi.mehta@gmail\\.com" or
    "^From:.*mbpledl@gmail\\.com" or
    "^From:.*mbrunlieb@(gmail|hotmail)\\.com" or
    "^From:.*preis23@gmail\\.com" or
    "^From:.*jolan@protection\\.cx" or
    "^From:.*digitek@charter\\.net" or
    "^From:.*rmainville@stewart-peterson\\.com" or
    "^From:.*thorubos@gmail\\.com" or
    "^From:.*wodtk005@umn\\.edu"
    in headers action "friend"

# GLOW/CHTC/CS.
match "^List-Id:.*glow-tech\\.cs\\.wisc\\.edu" in headers {
    match "^Subject: \\[glow-tech\\] GLOW Absent Report$" in headers action maildir "${hep}/monitor"
    match all action maildir "${hep}/glow"
}
match "From:.*chtc\\.wisc\\.edu" in headers {
    match "Subject: \\[Chtc-users\\] Daily CHTC usage" in headers action maildir "${hep}/monitor"
}
match "List-Id: <cs-announce\\.cs\\.wisc\\.edu>" in headers action "hep"

# CMS.
match "^X-CMSLIST:" or
    "^List-Owner:.*CMS.*@LISTSERV\\.FNAL\\.GOV" or
    "^From:.*arsystem@fnal.gov" in headers action maildir "${cms}/uscms-t2"
match "^List-Owner:.*OSG-STORAGE.*@LISTSERV\\.FNAL\\.GOV" in headers action maildir "${osg}/storage"
match "^List-Owner:.*OSG-SITES.*@LISTSERV\\.FNAL\\.GOV" in headers action maildir "${osg}/sites"
match "^List-Owner:.*OSG-HADOOP-request@LISTSERV\\.FNAL\\.GOV" in headers action maildir "${osg}/hadoop"
match "^(To|Cc):.*project-indico-administrators@cern\\.ch" in headers action maildir "${cms}/indico"
match "^(To|Cc):.*@(lists[0-9]+)?\\.?slac\\.stanford\\.edu" in headers {
	match "^(To|Cc).*xrootd-l@" in headers action maildir "${cms}/xrootd"
}
match "^X-Hn-Forum:" in headers {
    match "X-Hn-Forum:.*/HyperNews/CMS/get/sc4\\.html" in headers action maildir "${cms}/hn.facilities"
    match "X-Hn-Forum:.*/HyperNews/CMS/get/t2\\.html" in headers action maildir "${cms}/hn.tier2"
    match "X-Hn-Forum:.*/HyperNews/CMS/get/gridAnnounce\\.html" in headers action maildir "${cms}/hn.grid"
}

# HEP.
match "^To:.*postmaster@hep.wisc.edu" in headers action "drop"
match "^X-Savane-Server: savannah.cern.ch:443" in headers action maildir "${hep}/savannah"
match "^List-Owner:.*JOBS-request@LISTSERV\\.FNAL\\.GOV" in headers {
    match ": cs, ..." in body action "hep"
    match all action "drop"
}
match "^From:.*cms-phedex-admins@cern\\.ch" in headers action maildir "${hep}/phedex"
match "^(From|To|Cc):.*@[^ ]*\\.?hep\\.wisc\\.edu" in headers {
    match "(From|To|Cc):.*(help|req)@(nod|ginseng)?\\.?hep\\.wisc\\.edu" in headers action maildir "${hep}/req"
    match 
        "^Subject: Wisconsin CMS Daily Condor Usage" or
        "^Subject: UW-HEP Condor Absent Report" or
        "^Subject: dCache daily disk usage by directory" or
        "^Subject: dCache Absent Pools Report" or
        "^Subject: Condor daily usage \\(HEP resources only\\)" or
        "^Subject: CFengine Absent Report" or
        "^Subject:.*dCache Health Report" or
        "^Subject:.*dCache Active Transfers Report" or
        "^Subject:.*Nagios .* Alert Report for" or
        "^Subject:.*Tracker Ticket Report" or
        "^Subject:.*check_failing_condor_jobs$" or
        "^Subject: Staging Transfers$"
        in headers action maildir "${hep}/monitor"
    match "^Subject: AIDE report" or "^Subject: .* file integrity .* report" in headers action maildir "${hep}/ids"
    # HEP root mail.
    match "^(From|To|Cc):.*(root|operator|cron)@[^ ]*\\.?hep" in headers action maildir "${hep}/root"
    match "^Subject: (UP|DOWN|RECOVERY|PROBLEM):" in headers action maildir "${hep}/nagios"
    match all action "hep"
}
match "^(To|Cc):.*(William\\.Maier|wcmaier)@cern\\.ch" in headers action "hep"

# Physics.
match "^(To|Cc):.*@[^ ]*\\.?physics\\.wisc\\.edu" in headers {
    match "^(To|Cc):.*(root|operator|cron)@" in headers action maildir "${hep}/root"
    match all action maildir "${hep}/department"
}

# SMS.
match in-cache "${cache}/sms" key "send-sms" {
    match tagged "sms-worthy" action "sms"
}

# Default filter.
match all action "default"
endif
